<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIC • Identificador Víctima y Agresor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .gradient-bg { background: linear-gradient(135deg, #0F1F38 0%, #1a2332 100%); min-height: 100vh; }
    .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.2); }
    .card { box-shadow: 0 25px 50px rgba(0,0,0,0.3); border-radius: 1.5rem; }
    .tab-active { background: #475569; color: white; }
    .tab-inactive { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
    .progress-bar { width: 0%; transition: width 0.5s ease; }
    .slider-red::-webkit-slider-thumb { background: #ef4444; }
    .slider-blue::-webkit-slider-thumb { background: #3b82f6; }
    .slider-purple::-webkit-slider-thumb { background: #a855f7; }
  </style>
</head>
<body class="gradient-bg text-white font-sans">

  <!-- Header -->
  <header class="glass border-b border-white border-opacity-20">
    <div class="max-w-7xl mx-auto px-6 py-6 flex justify-between items-center">
      <div class="flex items-center space-x-5">
        <div class="w-14 h-14 bg-gradient-to-br from-red-600 to-red-800 rounded-2xl flex items-center justify-center shadow-2xl">
          <svg class="w-9 h-9" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold">SIC • Identificador Víctima y Agresor</h1>
          <p class="text-lg opacity-80">Detección automática de violencia con IA</p>
        </div>
      </div>
      <div class="flex items-center space-x-3 bg-emerald-600 bg-opacity-20 px-5 py-3 rounded-xl border border-emerald-500">
        <div class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></div>
        <span class="font-medium">Sistema Activo</span>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-6 py-10">

    <!-- Input + Tabs -->
    <div class="glass card p-10 mb-10">
      <div class="flex justify-center space-x-6 mb-10">
        <button id="tab-local" class="tab-active px-10 py-4 rounded-2xl font-bold text-xl transition-all">Subir Video</button>
        <button id="tab-yt" class="tab-inactive px-10 py-4 rounded-2xl font-bold text-xl transition-all">YouTube</button>
      </div>

      <div id="local-content">
        <div class="border-4 border-dashed border-white border-opacity-30 rounded-3xl p-20 text-center hover:border-white hover:border-opacity-60 transition-all cursor-pointer" onclick="document.getElementById('video-file').click()">
          <input type="file" id="video-file" accept="video/*" class="hidden">
          <svg class="w-24 h-24 mx-auto mb-6 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <p class="text-3xl font-bold mb-4">Arrastra tu video aquí</p>
          <p class="text-xl opacity-80 mb-8">o haz clic para seleccionar</p>
          <button class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 px-12 py-5 rounded-2xl font-bold text-2xl shadow-2xl transform hover:scale-105 transition">
            Seleccionar Video
          </button>
          <p id="file-info" class="mt-10 text-green-400 text-2xl font-bold"></p>
        </div>
      </div>

      <div id="yt-content" class="hidden">
        <input type="text" id="yt-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-8 py-6 text-2xl bg-white bg-opacity-10 rounded-2xl border border-white border-opacity-30 focus:outline-none focus:border-white placeholder-gray-400">
      </div>
    </div>

    <!-- Parámetros -->
    <div class="glass card p-10 mb-10">
      <h2 class="text-3xl font-bold mb-8 text-center">Parámetros de Detección</h2>
      <div class="grid md:grid-cols-3 gap-10">
        <div>
          <label class="text-red-400 text-xl font-bold block mb-3">Umbral Agresor</label>
          <input type="range" id="agg_thr" min="1.0" max="5.0" step="0.1" value="2.8" class="w-full h-4 rounded-lg slider-red">
          <div class="flex justify-between mt-2 text-lg"><span>1.0</span><span id="agg_val" class="font-bold text-red-400">2.8</span><span>5.0</span></div>
        </div>
        <div>
          <label class="text-blue-400 text-xl font-bold block mb-3">Umbral Víctima</label>
          <input type="range" id="vic_thr" min="0.5" max="3.0" step="0.1" value="1.5" class="w-full h-4 rounded-lg slider-blue">
          <div class="flex justify-between mt-2 text-lg"><span>0.5</span><span id="vic_val" class="font-bold text-blue-400">1.5</span><span>3.0</span></div>
        </div>
        <div>
          <label class="text-purple-400 text-xl font-bold block mb-3">Proximidad (px)</label>
          <input type="range" id="prox_thr" min="50" max="300" step="10" value="140" class="w-full h-4 rounded-lg slider-purple">
          <div class="flex justify-between mt-2 text-lg"><span>50</span><span id="prox_val" class="font-bold text-purple-400">140</span><span>300</span></div>
        </div>
      </div>
    </div>

    <!-- Botón Principal -->
    <div class="text-center my-16">
      <button id="analyze-btn" class="bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-bold text-4xl py-8 px-40 rounded-3xl shadow-2xl transform hover:scale-105 transition-all duration-300">
        INICIAR ANÁLISIS CON IA
      </button>
    </div>

    <!-- Progreso -->
    <div id="progress" class="hidden glass card p-12 text-center">
      <h3 class="text-4xl font-bold mb-8">Procesando con Inteligencia Artificial...</h3>
      <div class="w-full bg-white bg-opacity-20 rounded-full h-16 overflow-hidden">
        <div id="bar" class="progress-bar bg-gradient-to-r from-red-600 to-red-800 h-full flex items-center justify-center text-3xl font-bold">0%</div>
      </div>
    </div>

    <!-- Resultados -->
    <div id="results" class="hidden space-y-12 mt-16">
      <h2 class="text-5xl font-bold text-center mb-12">Resultados del Análisis</h2>

      <div class="grid md:grid-cols-2 gap-12">
        <div class="glass card p-10">
          <h3 class="text-3xl font-bold mb-6">Resumen Completo</h3>
          <pre id="summary" class="bg-black bg-opacity-40 p-8 rounded-2xl text-lg leading-relaxed whitespace-pre-wrap"></pre>
        </div>
        <div class="glass card p-10">
          <h3 class="text-3xl font-bold mb-6">Video Procesado</h3>
          <video id="output-video" controls class="w-full rounded-2xl shadow-2xl"></video>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
        <div class="text-center glass card p-10">
          <div id="aggressors" class="text-7xl font-bold text-red-500">0</div>
          <p class="text-2xl mt-4">Agresores Detectados</p>
        </div>
        <div class="text-center glass card p-10">
          <div id="victims" class="text-7xl font-bold text-blue-500">0</div>
          <p class="text-2xl mt-4">Víctimas Detectadas</p>
        </div>
        <div class="text-center glass card p-10">
          <div id="violent-frames" class="text-7xl font-bold text-green-500">0</div>
          <p class="text-2xl mt-4">Frames con Violencia</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // CAMBIA ESTO SEGÚN TU SPACE
    const BACKEND = "/api/process"; // Recomendado: tu proxy en Vercel
    // const BACKEND = "https://camcel-sic.hf.space/predict"; // Solo si ya tienes /predict

    // Tabs
    document.getElementById('tab-local').onclick = () => switchTab(true);
    document.getElementById('tab-yt').onclick = () => switchTab(false);
    function switchTab(local) {
      document.getElementById('tab-local').className = local ? 'tab-active px-10 py-4 rounded-2xl font-bold text-xl transition-all' : 'tab-inactive px-10 py-4 rounded-2xl font-bold text-xl transition-all';
      document.getElementById('tab-yt').className = local ? 'tab-inactive px-10 py-4 rounded-2xl font-bold text-xl transition-all' : 'tab-active px-10 py-4 rounded-2xl font-bold text-xl transition-all';
      document.getElementById('local-content').classList.toggle('hidden', !local);
      document.getElementById('yt-content').classList.toggle('hidden', local);
    }

    // Mostrar nombre y tamaño del archivo
    document.getElementById('video-file').onchange = () => {
      const f = document.getElementById('video-file').files[0];
      if (f) document.getElementById('file-info').textContent = `Listo: ${f.name} (${(f.size/1024/1024).toFixed(1)} MB)`;
    };

    // Actualizar valores en vivo
    document.getElementById('agg_thr').oninput = (e) => document.getElementById('agg_val').textContent = e.target.value;
    document.getElementById('vic_thr').oninput = (e) => document.getElementById('vic_val').textContent = e.target.value;
    document.getElementById('prox_thr').oninput = (e) => document.getElementById('prox_val').textContent = e.target.value;

    // ANÁLISIS
    document.getElementById('analyze-btn').onclick = async () => {
      const file = document.getElementById('video-file').files[0];
      const yt = document.getElementById('yt-url').value.trim();
      if (!file && !yt) return alert("Por favor sube un video o pega un enlace de YouTube");

      const form = new FormData();
      if (file) form.append("video", file);
      if (yt) form.append("youtube_url", yt);
      form.append("aggressor_threshold", document.getElementById('agg_thr').value);
      form.append("victim_threshold", document.getElementById('vic_thr').value);
      form.append("proximity_threshold", document.getElementById('prox_thr').value);
      form.append("mostrar_interaccion", "Ambos");

      document.getElementById('progress').classList.remove('hidden');
      document.getElementById('results').classList.add('hidden');

      let p = 0;
      const iv = setInterval(() => {
        p = Math.min(p + 10, 90);
        document.getElementById('bar').style.width = p + '%';
        document.getElementById('bar').textContent = p + '%';
      }, 800);

      try {
        const r = await fetch(BACKEND, { method: "POST", body: form });
        if (!r.ok) throw new Error(`Error ${r.status} → Asegúrate de tener @app.post("/predict") en tu Space`);
        const data = await r.json();

        clearInterval(iv);
        document.getElementById('bar').style.width = '100%';
        document.getElementById('bar').textContent = '100%';

        setTimeout(() => {
          document.getElementById('progress').classList.add('hidden');
          document.getElementById('results').classList.remove('hidden');
          document.getElementById('summary').textContent = data.resumen || "Análisis completado";
          if (data.video) document.getElementById('output-video').src = "data:video/mp4;base64," + data.video;
          document.getElementById('aggressors').textContent = data.agresores || 0;
          document.getElementById('victims').textContent = data.victimas || 0;
          document.getElementById('violent-frames').textContent = data.agg_frames || data.frames_procesados || 0;
        }, 1000);

      } catch (e) {
        clearInterval(iv);
        document.getElementById('progress').classList.add('hidden');
        alert("ERROR: " + e.message + "\n\nRevisa que tu Space tenga:\n→ @app.post('/predict')\n→ deep-sort-realtime==1.3.2");
      }
    };
  </script>
</body>
</html>
