<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Identificador Víctima y Agresor</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        pre {
            white-space: pre-wrap;
            background: #f7f7f7;
            padding: 1rem;
            border-radius: 0.5rem;
        }

        #loader {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center px-4">

<div class="w-full max-w-3xl py-10">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
        Identificador Víctima y Agresor
    </h1>

    <div class="bg-white p-6 rounded-xl shadow-md border">

        <form id="form" class="space-y-6">

            <div>
                <label class="block font-semibold text-gray-700 mb-1">Subir video</label>
                <input type="file" id="video" name="video" accept="video/*"
                    class="w-full border rounded p-2">
            </div>

            <div>
                <label class="block font-semibold text-gray-700 mb-1">O URL de YouTube</label>
                <input type="text" id="youtube_url" name="youtube_url"
                       placeholder="https://youtube.com/..."
                       class="w-full border rounded p-2">
            </div>

            <div>
                <label class="block font-semibold text-gray-700 mb-1">Mostrar interacción</label>
                <select id="mostrar_interaccion" name="mostrar_interaccion"
                        class="w-full border rounded p-2 bg-white">
                    <option value="Ambos">Ambos</option>
                    <option value="Agresor">Agresor</option>
                    <option value="Víctima">Víctima</option>
                </select>
            </div>

            <button type="submit"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
                Procesar Video
            </button>
        </form>

        <!-- Loader -->
        <div id="loader" class="mt-6 text-center">
            <div class="animate-spin h-8 w-8 mx-auto border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p class="text-gray-600 mt-2 font-medium">Procesando... Esto puede tardar 20–40 segundos.</p>
        </div>

        <!-- Results -->
        <div id="results" class="mt-8"></div>

    </div>
</div>

<script>
const BACKEND_BASE = "/api"; // No tocar

const form = document.getElementById("form");
const results = document.getElementById("results");
const loader = document.getElementById("loader");

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    loader.style.display = "block";
    results.innerHTML = "";

    const fd = new FormData(form);

    try {
        const r = await fetch(BACKEND_BASE + "/process", {
            method: "POST",
            body: fd
        });

        const text = await r.text();

        let data;
        try {
            data = JSON.parse(text);
        } catch (err) {
            results.innerHTML = `
                <p class="text-red-600 font-semibold">Error del servidor: respuesta inesperada.</p>
                <pre>${text}</pre>
            `;
            loader.style.display = "none";
            return;
        }

        loader.style.display = "none";

        if (data.error) {
            results.innerHTML = `<p class="text-red-600 font-semibold">${data.error}</p>`;
            return;
        }

        let html = "";

        if (data.resumen) {
            html += `<div class="mb-4"><pre>${data.resumen}</pre></div>`;
        }

        if (data.video) {
            html += `
                <h3 class="font-semibold text-gray-800 mt-6">Video procesado</h3>
                <video id="output-video" controls class="rounded-lg shadow-md mt-2 w-full"
                    src="data:video/mp4;base64,${data.video}">
                </video>`;
        }

        if (data.selected_img) {
            html += `
                <h3 class="font-semibold text-gray-800 mt-6">Frame seleccionado</h3>
                <img id="output-img" class="rounded-lg shadow mt-2"
                     src="data:image/jpeg;base64,${data.selected_img}">`;
        }

        results.innerHTML = html;

    } catch (error) {
        loader.style.display = "none";
        results.innerHTML = `<p class="text-red-600 font-semibold">Error: ${error.message}</p>`;
    }
});

/* Cambio de imagen sin reprocesar */
async function changeImage() {
    const fd = new FormData();
    fd.append("mostrar_interaccion", document.getElementById("mostrar_interaccion").value);

    const r = await fetch(BACKEND_BASE + "/change_image", {
        method: "POST",
        body: fd
    });

    const data = await r.json();
    if (data.selected_img) {
        document.getElementById("output-img").src =
            "data:image/jpeg;base64," + data.selected_img;
    }
}

document.getElementById("mostrar_interaccion").addEventListener("change", changeImage);
</script>

</body>
</html>
