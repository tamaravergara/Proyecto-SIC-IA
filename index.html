<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Identificador Víctima y Agresor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 to-black text-white flex items-center justify-center p-4">

<div class="max-w-2xl w-full space-y-8">
  <div class="text-center">
    <h1 class="text-4xl font-bold mb-2">Identificador Víctima y Agresor</h1>
    <p class="opacity-80">Sube un video o pega un link de YouTube</p>
  </div>

  <!-- Subir archivo -->
  <div class="bg-white/10 backdrop-blur rounded-2xl p-8 border border-white/20">
    <input type="file" id="video" accept="video/*" class="hidden">
    <div class="border-4 border-dashed border-white/30 rounded-xl p-12 text-center cursor-pointer hover:border-white/60 transition"
         onclick="document.getElementById('video').click()">
      <p class="text-xl mb-4">Arrastra tu video aquí o haz clic</p>
      <button class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-lg font-bold">Seleccionar archivo</button>
      <p id="filename" class="mt-4 text-green-400 font-bold"></p>
    </div>
  </div>

  <!-- O YouTube -->
  <div class="text-center text-2xl opacity-60">o</div>
  <input type="text" id="youtube" placeholder="https://youtube.com/watch?v=..." 
         class="w-full px-6 py-4 bg-white/10 border border-white/30 rounded-xl focus:outline-none focus:border-white">

  <!-- Botón -->
  <div class="text-center">
    <button id="btn" class="bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white font-bold text-2xl py-6 px-20 rounded-2xl shadow-2xl transform hover:scale-105 transition">
      INICIAR ANÁLISIS
    </button>
  </div>

  <!-- Progreso y resultados -->
  <div id="progress" class="hidden text-center space-y-6">
    <p class="text-2xl">Procesando con IA...</p>
    <div class="w-full bg-gray-700 rounded-full h-12 overflow-hidden">
      <div id="bar" class="h-full bg-gradient-to-r from-red-600 to-orange-600 text-white font-bold text-xl flex items-center justify-center" style="width:0%">0%</div>
    </div>
  </div>

  <div id="result" class="hidden space-y-8">
    <div class="bg-white/10 backdrop-blur rounded-2xl p-8">
      <pre id="summary" class="whitespace-pre-wrap text-lg"></pre>
    </div>
    <video id="output" controls class="w-full rounded-2xl shadow-2xl"></video>
  </div>
</div>

<script>
  // ESTE PROXY SÍ FUNCIONA HOY (14 nov 2025) con videos grandes
  const PROXY = "https://corsproxy.io/?";
  const BACKEND = PROXY + encodeURIComponent("https://camcel-identificador-victima-y-agresor.hf.space/predict");

  document.getElementById('video').onchange = () => {
    const f = document.getElementById('video').files[0];
    if (f) document.getElementById('filename').textContent = "Listo: " + f.name + " (" + (f.size/1024/1024).toFixed(1) + " MB)";
  };

  document.getElementById('btn').onclick = async () => {
    const file = document.getElementById('video').files[0];
    const yt = document.getElementById('youtube').value.trim();

    if (!file && !yt) return alert("Sube un video o pega un link de YouTube");

    const form = new FormData();
    if (file) form.append("video", file);
    if (yt) form.append("youtube_url", yt);
    form.append("aggressor_threshold", "2.8");
    form.append("victim_threshold", "1.5");
    form.append("proximity_threshold", "140");
    form.append("mostrar_interaccion", "Ambos");

    document.getElementById('progress').classList.remove('hidden');
    document.getElementById('result').classList.add('hidden');
    let p = 0;
    const iv = setInterval(() => {
      p += 12;
      if (p > 90) p = 90;
      document.getElementById('bar').style.width = p + '%';
      document.getElementById('bar').textContent = p + '%';
    }, 1000);

    try {
      const res = await fetch(BACKEND, { method: "POST", body: form });
      if (!res.ok) throw new Error("Error " + res.status);
      const data = await res.json();

      clearInterval(iv);
      document.getElementById('bar').style.width = '100%';
      document.getElementById('bar').textContent = '100%';

      setTimeout(() => {
        document.getElementById('progress').classList.add('hidden');
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('summary').textContent = data.resumen || "Análisis completado";
        if (data.video) document.getElementById('output').src = "data:video/mp4;base64," + data.video;
      }, 800);

    } catch (e) {
      clearInterval(iv);
      document.getElementById('progress').classList.add('hidden');
      alert("Error: " + e.message + "\nInténtalo con un video más corto o con YouTube");
    }
  };
</script>
</body>
</html>

