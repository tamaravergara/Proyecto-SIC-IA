<!doctype html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Identificador V√≠ctima y Agresor</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { box-sizing: border-box; }
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
    }
    .glass-effect {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .card-shadow {
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.12), 0 10px 10px -5px rgba(0,0,0,0.06);
    }
    .processing-animation { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    .tab-active { background: linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; }
    .tab-inactive { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
    .progress-bar { width: 0%; transition: width .25s ease; }
    pre { white-space: pre-wrap; }
  </style>
</head>

<body class="h-full gradient-bg font-sans text-gray-900">
  <main class="min-h-full">
    <!-- Header -->
    <header class="glass-effect border-b border-white border-opacity-10">
      <div class="max-w-7xl mx-auto px-6 py-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-purple-500 rounded-xl flex items-center justify-center">
              <!-- icon -->
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </div>
            <div>
              <h1 id="main-title" class="text-2xl font-bold text-white">Identificador V√≠ctima y Agresor</h1>
              <p id="subtitle" class="text-sm text-white text-opacity-80">Sistema de Detecci√≥n de Violencia con IA</p>
            </div>
          </div>
          <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 bg-green-500 bg-opacity-20 px-3 py-2 rounded-lg">
              <div class="w-2 h-2 bg-green-400 rounded-full processing-animation"></div>
              <span class="text-green-300 text-sm font-medium">Sistema Listo</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8">

      <!-- MAIN CARD: form + params + process -->
      <form id="main-form" class="bg-white rounded-2xl card-shadow p-8 mb-8" enctype="multipart/form-data">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
          <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
          Fuente de Video
        </h2>

        <!-- Tabs -->
        <div class="flex space-x-2 mb-6">
          <button type="button" id="upload-tab" class="tab-active px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                                         d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
            <span id="upload-tab-title">Subir Video Local</span>
          </button>

          <button type="button" id="youtube-tab" class="tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                                         d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
            <span id="youtube-tab-title">URL de YouTube</span>
          </button>
        </div>

        <!-- Upload Content -->
        <div id="upload-content" class="tab-content">
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors duration-200">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                                                                 d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            <h3 class="text-lg font-medium text-gray-700 mb-2">Arrastra tu video aqu√≠</h3>
            <p class="text-gray-500 mb-4">o haz clic para seleccionar un archivo</p>

            <!-- Actual file input (name "video" for backend) -->
            <input type="file" id="video-upload" name="video" accept="video/*" class="hidden" />
            <div id="upload-area-controls" class="flex items-center justify-center gap-4">
              <button type="button" id="choose-file-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors duration-200">Seleccionar Video</button>
              <div id="upload-filename" class="text-sm text-gray-500"></div>
            </div>

            <p class="text-xs text-gray-400 mt-4">Formatos soportados: MP4, AVI, MOV, MKV</p>
          </div>
        </div>

        <!-- YouTube content -->
        <div id="youtube-content" class="tab-content hidden">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">URL de YouTube</label>
              <input type="url" id="youtube-url" name="youtube_url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                                                                                         d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div>
                  <h4 class="text-sm font-medium text-blue-800">Nota sobre videos de YouTube</h4>
                  <p class="text-sm text-blue-700 mt-1">El procesamiento puede tomar m√°s tiempo dependiendo de la duraci√≥n y calidad del video.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PARAMETERS -->
        <div class="mt-8 border-t pt-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Par√°metros de Detecci√≥n</h3>
            <button type="button" id="toggle-params" class="text-blue-600 hover:text-blue-700 font-medium flex items-center space-x-1">
              <span>Mostrar Avanzados</span>
              <svg id="toggle-icon" class="w-4 h-4 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
          </div>

          <!-- Basic param grid -->
          <div id="basic-params" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">

            <!-- Aggressor threshold -->
            <div class="space-y-2 p-4 bg-red-50 rounded-lg border border-red-200">
              <label class="block text-sm font-medium text-red-800">Umbral Agresor: <span id="val-aggressor" class="font-medium">2.8</span></label>
              <input type="range" id="aggressor_threshold" name="aggressor_threshold" min="0.5" max="5" step="0.1" value="2.8" class="w-full accent-red-500">
              <div class="flex justify-between text-xs text-red-600"><span>Permisivo</span> <span class="font-medium">2.8</span> <span>Estricto</span></div>
            </div>

            <!-- Victim threshold -->
            <div class="space-y-2 p-4 bg-blue-50 rounded-lg border border-blue-200">
              <label class="block text-sm font-medium text-blue-800">Umbral V√≠ctima: <span id="val-victim" class="font-medium">1.5</span></label>
              <input type="range" id="victim_threshold" name="victim_threshold" min="0" max="3" step="0.1" value="1.5" class="w-full accent-blue-500">
              <div class="flex justify-between text-xs text-blue-600"><span>Permisivo</span> <span class="font-medium">1.5</span> <span>Estricto</span></div>
            </div>

            <!-- Proximity -->
            <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
              <label class="block text-sm font-medium text-purple-800">Distancia de Proximidad (px): <span id="val-prox" class="font-medium">140</span></label>
              <input type="range" id="proximity_threshold" name="proximity_threshold" min="50" max="300" step="5" value="140" class="w-full accent-purple-500">
              <div class="flex justify-between text-xs text-purple-600"><span>50px</span> <span class="font-medium">140px</span> <span>300px</span></div>
            </div>

            <!-- Min duration frames -->
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <label class="block text-sm font-medium text-gray-700">Frames m√≠nimos (duraci√≥n): <span id="val-minframes" class="font-medium">15</span></label>
              <input type="range" id="min_duration_frames" name="min_duration_frames" min="1" max="200" step="1" value="15" class="w-full">
              <div class="flex justify-between text-xs text-gray-500"><span>1</span> <span class="font-medium">15</span> <span>200</span></div>
            </div>

          </div>

          <!-- Advanced controls (hidden by default) -->
          <div id="advanced-params" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- dist_threshold_px -->
              <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium">dist_threshold_px: <span id="val-distpx" class="font-medium">85</span></label>
                <input type="range" id="dist_threshold_px" name="dist_threshold_px" min="20" max="300" step="1" value="85" class="w-full">
              </div>

              <!-- speed_threshold -->
              <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium">speed_threshold: <span id="val-speed" class="font-medium">0.04</span></label>
                <input type="range" id="speed_threshold" name="speed_threshold" min="0" max="1" step="0.01" value="0.04" class="w-full">
              </div>

              <!-- fist_distance_threshold -->
              <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium">fist_distance_threshold: <span id="val-fist" class="font-medium">0.08</span></label>
                <input type="range" id="fist_distance_threshold" name="fist_distance_threshold" min="0.01" max="0.5" step="0.01" value="0.08" class="w-full">
              </div>

              <!-- face_cover_threshold -->
              <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium">face_cover_threshold: <span id="val-face" class="font-medium">0.10</span></label>
                <input type="range" id="face_cover_threshold" name="face_cover_threshold" min="0.01" max="0.5" step="0.01" value="0.10" class="w-full">
              </div>

              <!-- crouch_threshold -->
              <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium">crouch_threshold: <span id="val-crouch" class="font-medium">0.25</span></label>
                <input type="range" id="crouch_threshold" name="crouch_threshold" min="0.1" max="1" step="0.01" value="0.25" class="w-full">
              </div>

              <!-- disappearance_threshold -->
              <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium">disappearance_threshold: <span id="val-disap" class="font-medium">25</span></label>
                <input type="range" id="disappearance_threshold" name="disappearance_threshold" min="1" max="100" step="1" value="25" class="w-full">
              </div>

              <!-- movement_history -->
              <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium">movement_history: <span id="val-movhist" class="font-medium">15</span></label>
                <input type="range" id="movement_history" name="movement_history" min="1" max="100" step="1" value="15" class="w-full">
              </div>
            </div>
          </div>
        </div>

        <!-- Process button -->
        <div class="text-center mt-6">
          <!-- mostrar_interaccion select outside params for easy access -->
          <div class="mb-4">
            <label class="mr-2 text-sm font-medium text-gray-700">Mostrar interacci√≥n:</label>
            <select id="mostrar_interaccion" name="mostrar_interaccion" class="px-3 py-2 rounded border">
              <option value="Ambos">Ambos</option>
              <option value="Agresor">Agresor</option>
              <option value="V√≠ctima">V√≠ctima</option>
            </select>
          </div>

          <button type="submit" id="process-btn" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-10 rounded-xl text-lg transition-all duration-200 transform hover:scale-105 shadow-lg">
            <span id="process-button-text">üöÄ Iniciar An√°lisis con IA</span>
          </button>
          <p class="text-gray-500 text-sm mt-2">El procesamiento puede tomar varios minutos dependiendo del video</p>
        </div>
      </form>

      <!-- Progress / Processing Card -->
      <div id="progress-container" class="hidden bg-white rounded-2xl card-shadow p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800">Procesando Video...</h3>
          <span id="progress-text" class="text-sm text-gray-600">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progress-bar" class="progress-bar bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full"></div>
        </div>
        <div class="flex items-center justify-center mt-4 text-sm text-gray-600">
          <svg class="w-4 h-4 mr-2 processing-animation" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547"/></svg>
          Analizando posturas y movimientos con YOLO + DeepSort
        </div>
      </div>

      <!-- Results section (hidden until processed) -->
      <div id="results-section" class="hidden">
        <h2 id="results-title" class="text-3xl font-bold text-white mb-6 text-center">Resultados del An√°lisis</h2>

        <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Selector de Vista</h3>
          <div class="flex flex-wrap gap-3">
            <button type="button" class="view-btn active bg-blue-500 text-white px-4 py-2 rounded-lg font-medium" data-view="both">üë• Ambos</button>
            <button type="button" class="view-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-view="aggressor">üî¥ Solo Agresor</button>
            <button type="button" class="view-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium" data-view="victim">üîµ Solo V√≠ctima</button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div id="video-result" class="result-card bg-white rounded-2xl card-shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Video Procesado</h3>
            <div id="video-placeholder" class="bg-gray-100 rounded-lg aspect-video flex items-center justify-center">
              <div class="text-center text-gray-500">
                <p id="video-placeholder-text">Video con detecciones aparecer√° aqu√≠</p>
              </div>
            </div>
          </div>

          <div id="first-interaction" class="result-card bg-white rounded-2xl card-shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Primera Interacci√≥n</h3>
            <div id="first-placeholder" class="bg-gray-100 rounded-lg aspect-video flex items-center justify-center">
              <div class="text-center text-gray-500">
                <p id="first-placeholder-text">Captura del momento cr√≠tico</p>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl card-shadow p-6 mt-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-6">Resumen Estad√≠stico</h3>
          <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
              <div id="stat-aggressors" class="text-3xl font-bold text-red-600">-</div>
              <div class="text-sm text-red-700">Agresores Detectados</div>
            </div>
            <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
              <div id="stat-victims" class="text-3xl font-bold text-blue-600">-</div>
              <div class="text-sm text-blue-700">V√≠ctimas Identificadas</div>
            </div>
            <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
              <div id="stat-duration" class="text-3xl font-bold text-yellow-600">-</div>
              <div class="text-sm text-yellow-700">Duraci√≥n del Incidente</div>
            </div>
          </div>

          <div id="analysis-details" class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-2">Detalles del An√°lisis:</h4>
            <pre id="analysis-pre" class="text-sm text-gray-600">Sin resultados a√∫n.</pre>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    // -----------------------
    // UI wiring & behavior
    // -----------------------
    const BACKEND_BASE = "/api"; // proxy via vercel.json

    // Tabs
    document.getElementById('upload-tab').addEventListener('click', () => switchTab('upload'));
    document.getElementById('youtube-tab').addEventListener('click', () => switchTab('youtube'));
    function switchTab(tab) {
      document.getElementById('upload-tab').className = tab === 'upload' ? 'tab-active px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2' : 'tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2';
      document.getElementById('youtube-tab').className = tab === 'youtube' ? 'tab-active px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2' : 'tab-inactive px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2';
      document.getElementById('upload-content').classList.toggle('hidden', tab !== 'upload');
      document.getElementById('youtube-content').classList.toggle('hidden', tab !== 'youtube');
    }

    // Toggle advanced params
    document.getElementById('toggle-params').addEventListener('click', () => {
      const adv = document.getElementById('advanced-params');
      const isHidden = adv.classList.contains('hidden');
      adv.classList.toggle('hidden');
      document.getElementById('toggle-params').querySelector('span').textContent = isHidden ? 'Ocultar Avanzados' : 'Mostrar Avanzados';
      document.getElementById('toggle-icon').style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    });

    // File input handling
    const videoInput = document.getElementById('video-upload');
    const chooseBtn = document.getElementById('choose-file-btn');
    const filenameEl = document.getElementById('upload-filename');

    chooseBtn.addEventListener('click', () => videoInput.click());
    videoInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        filenameEl.textContent = e.target.files[0].name;
      } else {
        filenameEl.textContent = '';
      }
    });

    // Sliders: reflect values in labels
    const sliderPairs = [
      ['aggressor_threshold','val-aggressor'],
      ['victim_threshold','val-victim'],
      ['proximity_threshold','val-prox'],
      ['min_duration_frames','val-minframes'],
      ['dist_threshold_px','val-distpx'],
      ['speed_threshold','val-speed'],
      ['fist_distance_threshold','val-fist'],
      ['face_cover_threshold','val-face'],
      ['crouch_threshold','val-crouch'],
      ['disappearance_threshold','val-disap'],
      ['movement_history','val-movhist']
    ];
    sliderPairs.forEach(([id,label]) => {
      const s = document.getElementById(id);
      const l = document.getElementById(label);
      if (s && l) {
        l.textContent = s.value;
        s.addEventListener('input', () => { l.textContent = s.value; });
      }
    });

    // Process form submit
    const form = document.getElementById('main-form');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const resultsSection = document.getElementById('results-section');

    let progressInterval = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      // Reset UI
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      progressContainer.classList.remove('hidden');
      resultsSection.classList.add('hidden');

      // Start simulated progress while waiting for server
      let progress = 0;
      progressInterval = setInterval(() => {
        progress = Math.min(95, progress + (Math.random() * 12));
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
      }, 300);

      // Build FormData automatically (includes named inputs + file)
      const fd = new FormData(form);

      try {
        const resp = await fetch(BACKEND_BASE + '/process', { method: 'POST', body: fd });
        const text = await resp.text();
        // Try JSON parse, otherwise show HTML/text error
        let data;
        try {
          data = JSON.parse(text);
        } catch (err) {
          clearInterval(progressInterval);
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          progressContainer.classList.add('hidden');
          resultsSection.classList.remove('hidden');
          document.getElementById('analysis-pre').textContent = 'Respuesta inesperada del servidor:\n' + text;
          return;
        }

        // success ‚Äî fill UI
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        setTimeout(() => { progressContainer.classList.add('hidden'); }, 600);

        // Show resumen and results
        resultsSection.classList.remove('hidden');
        // Show resumen in details
        document.getElementById('analysis-pre').textContent = data.resumen || 'Sin resumen';

        // Video
        if (data.video) {
          const videoHtml = document.createElement('video');
          videoHtml.controls = true;
          videoHtml.className = 'rounded-lg shadow-md mt-2 w-full';
          videoHtml.src = "data:video/mp4;base64," + data.video;
          const placeholder = document.getElementById('video-placeholder');
          placeholder.innerHTML = '';
          placeholder.appendChild(videoHtml);
        } else {
          document.getElementById('video-placeholder-text').textContent = 'No hay video procesado disponible.';
        }

        // Selected image depending on mostrar_interaccion
        const selImgBase64 = data.selected_img;
        if (selImgBase64) {
          const img = document.createElement('img');
          img.className = 'rounded-lg shadow mt-2 max-h-96 object-contain';
          img.src = "data:image/jpeg;base64," + selImgBase64;
          const firstPlaceholder = document.getElementById('first-placeholder');
          firstPlaceholder.innerHTML = '';
          firstPlaceholder.appendChild(img);
        } else {
          document.getElementById('first-placeholder-text').textContent = 'No hay imagen seleccionada.';
        }

        // Update basic stats (try to parse from resumen heuristically if provided)
        // If the backend returns structured log_json later, prefer that.
        if (data.resumen) {
          // Quick parsing of numbers (best-effort)
          const txt = data.resumen;
          const mAgg = txt.match(/Agresores √∫nicos[:\s]*([0-9]+)/i);
          const mVic = txt.match(/V√≠ctimas √∫nicas[:\s]*([0-9]+)/i);
          const mFrames = txt.match(/Frames procesados[:\s]*([0-9,]+)/i);
          document.getElementById('stat-aggressors').textContent = mAgg ? mAgg[1] : '-';
          document.getElementById('stat-victims').textContent = mVic ? mVic[1] : '-';
          document.getElementById('stat-duration').textContent = mFrames ? mFrames[1].replace(/,/g, '') : '-';
        }

      } catch (err) {
        clearInterval(progressInterval);
        progressContainer.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        document.getElementById('analysis-pre').textContent = 'Error de red: ' + err.message;
      }
    });

    // change image without reprocessing
    async function changeImage() {
      const fd = new FormData();
      fd.append('mostrar_interaccion', document.getElementById('mostrar_interaccion').value);
      try {
        const r = await fetch(BACKEND_BASE + '/change_image', { method: 'POST', body: fd });
        const data = await r.json();
        if (data.selected_img) {
          // if results were displayed, replace image
          const firstPlaceholder = document.getElementById('first-placeholder');
          firstPlaceholder.innerHTML = '';
          const img = document.createElement('img');
          img.className = 'rounded-lg shadow mt-2 max-h-96 object-contain';
          img.src = "data:image/jpeg;base64," + data.selected_img;
          firstPlaceholder.appendChild(img);
        }
      } catch (err) {
        console.error('change_image error', err);
      }
    }
    document.getElementById('mostrar_interaccion').addEventListener('change', changeImage);

    // view selector buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-btn').forEach(b => b.className = 'view-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium');
        btn.className = 'view-btn active bg-blue-500 text-white px-4 py-2 rounded-lg font-medium';
        // could implement filtering of overlays/views later
      });
    });

    // optional: Element SDK init (if present)
    if (window.elementSdk) {
      const defaultConfig = {
        main_title: "Identificador V√≠ctima y Agresor",
        subtitle: "Sistema de Detecci√≥n de Violencia con IA",
        upload_tab_title: "Subir Video Local",
        youtube_tab_title: "URL de YouTube",
        process_button_text: "üöÄ Iniciar An√°lisis con IA",
        results_title: "Resultados del An√°lisis",
        background_color: "#1e3a8a",
        surface_color: "#ffffff",
        text_color: "#1f2937",
        primary_action_color: "#3b82f6",
        secondary_action_color: "#8b5cf6",
        font_family: "Inter",
        font_size: 16
      };
      window.elementSdk.init?.({
        defaultConfig,
        onConfigChange: async (c) => { /* not used heavily here */ },
        mapToCapabilities: () => ({})
      });
    }
  </script>
</body>
</html>

